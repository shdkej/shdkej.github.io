---
title: 아키텍처
summary:
date: 2021-05-20 20:33:31 +0100
updated: 2021-12-04 13:31:43 +0900
tags: meta
---

## 확장성

50 유저를 상대로 운영하고 있지만 10만 유저를 상대할때도 문제가 생기지 않게
염두에 두고 수정한다. 하지만 임시방편으로 해결할 때도 있다.
그런 임시방편을 잘 리스트화해서 처리를 잘 해야겠다

단일고장점이 없는 아키텍처라면
새로운 기술을 도입하는 것이 쉽게 될 수 있겠다

hdd로 구축된 서버에서 한대만 ssd로 교체해서 상황을 지켜보고, 문제가 있어도 다른
서버에서 커버할 수 있다면 문제점 파악하는데에 도움이 되겠다

소프트웨어 자체의 에러가 전체에 영향을 미치지 못하도록 하면 다른 것으로 교체하면
그만이라서 관리하기 쉽겠다

3대의 서버를 켜놓고 1대씩 리부팅을 해도 나머지 2대가 있어서 괜찮다면 오래 켜놔서
생기는 문제를 막을 수 있듯이
일부러 1대씩 계속 재부팅되도록 하고, 상태저장이 필요 없도록 하면 os의 문제에서
조금은 자유로워지지 않을까
재부팅하면 캐시가 다시 쌓여야하는 부분은 확인해봐야겠다

3대의 서버를 한 묶음으로 추가 자원이 필요하면 이 묶음이 여러개가 되도록 하면
확장성 문제도 해결되지 않을까?
쿠버네티스에서는 이를 지원해준다

쿠버네티스는 고가용성, 확장성, 배포를 바로 할 수 있게 해줘서 좋다
서버는 필연적으로 고가용성과 확장성과 배포가 필요하다
추가로 모니터링, 로깅도 세트다

#### portable, universal

새로운 기술이나 지식을 얻었을 때 우리의 업무에 바로 적용할 수 있는 자유로움

회사의 상황에 맞추기보다 표준에 맞추는 방향

데이터베이스를 커스터마이징하기보다 어댑터를 이용해 원본은 잘 지켜나가서 새로운
것이 생겼을 때 바로 도입할 수 있는 환경

#### 변하는 것과 변하지 않는 것 :vs:collection:

변하지 않는 것은 없지만 빠르게 변하는 것과 천천히 변하는 것은 나눠져 있다
아키텍처를 구성할 때 천천히 변하는 것을 잘 분리하여 빨리 변하는 것에 더 집중하고
천천히 변하는 것은 잘 유지할 수 있도록 하면 좋겠다

아이폰의 뒷면

#### 소프트웨어는 언제까지 확장되는게 좋을까

무한정 소프트웨어가 비대해지면 관리도 힘들고, 또 그렇게 커질 필요도 없다
네이버에서는 검색 기능은 다른 기능과 분리되어 있고, 팀도 따로 분리되어 있다.
회사 팀 구조도 개발팀을 다른 팀과 분리하는 경우도 있고,
기능별로 개발,디자인,기획을 같은 팀에 구성하는 경우도 있을텐데,
어떤 경우에 어떤 구성이 좋을까

#### 확장 -> [[모듈]]

각 서비스가 많은 트래픽을 감당할 수 있어야 하고,
분산 처리 시스템처럼, 묶였을 때 트래픽 처리가 선형적으로 증가 되야 한다

쉽게 교체할 수 있는 모듈의 형태로 구성되야 한다. 하지만 쉽게 교체할 수 있다는
것이 진리는 아니다.

기능별로 팀이 구성되 있을 때 그 팀에 오래 있던 사람이 나가고 새로운 사람이
들어오면 새로운 사람이 대체하려면 아주 힘들다. 애초에 대체는 안되고 다른 역할이
되겠지만.
메뉴얼이 쌓여있어도 기존 작업을 100% 알 수 없다.
기능별로 집중했기 때문에 깊고 많은 내용이 섞여있고, 그래서 기능적으로
성숙해졌지만 새로운 사람에게는 따라가야 할 길이 멀어진다.
이게 경험의 차이라고 불리워지는 것인 것 같다.
기능별 팀에서의 문제가 아니라 인간세상의 문제였다.

기능의 깊이가 어느정도 깊어지면 다시 분리해야 한다.
근데 사람의 수는 한정적이어서 분리가 안된다

## [[*아키텍처]]

> 정책과 세부사항으로, 룰과 가이드를 구분.
> 아키텍처의 목표는 정책과 세부사항을 적절히 구분해 세부사항의 결정은 최대한 미룰
> 수 있게 하는 것
>
> > 클린 아키텍처

아키텍처 구축의 목표점은 없다
**좋은 기준점을 만들어서 그 기준점을 계속 개선해나가는 것이 최선**

이런 관점에서 쿠버네티스, react, graphql, backend를 어떻게 구성해야하나?
정책과 세부사항이 너무 많으면 기준점을 잘 지켜나갈 수 있을까?

선택과 집중, 유연하고 융합적인 환경 - 두 가치를 어떻게 잘 융합할 수 있을까

분산화 하는 것이 시대의 흐름

심플하게 유지. 0에서 10은 심플이 아니다. 100에서 10이 심플

제한이 필요하다

큰 그림 > 작은 그림

비즈니스 로직에서 추상화를 어디까지 하는게 좋을까
과한 추상화는 실체가 없다는 느낌을 줄 수 있겠다.
어디까지 추상화를 할지는 어떤 목적으로 프로그램을 만드느냐에 따라 조정된다
모든 것이 추상화되고 가변적일 필요는 없다
Mysql tip 글에서 DB 모델링 시 지나친 추상화를 하지 말라는 조언이 있었다.

- 언어를 넘어서는 추상화
  - 포팅을 쉽게 할 정도의 추상화

설정가능해야하고 플러그인 방식으로 동작

#### 아키텍처 모범 사례

"서버 기반 아키텍처 모범 사례가 있습니다.(단일 장애 지점 제거, 배포 전 변경
사항 테스트, 중요한 데이터 암호화 등)"
https://dc2348.tistory.com/6#:~:text=%EC%84%9C%EB%B2%84%20%EA%B8%B0%EB%B0%98%20%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98%20%EB%AA%A8%EB%B2%94%20%EC%82%AC%EB%A1%80%EA%B0%80%20%EC%9E%88%EC%8A%B5%EB%8B%88%EB%8B%A4.(%EB%8B%A8%EC%9D%BC%20%EC%9E%A5%EC%95%A0%20%EC%A7%80%EC%A0%90%20%EC%A0%9C%EA%B1%B0%2C%20%EB%B0%B0%ED%8F%AC%20%EC%A0%84%20%EB%B3%80%EA%B2%BD%20%EC%82%AC%ED%95%AD%20%ED%85%8C%EC%8A%A4%ED%8A%B8%2C%20%EC%A4%91%EC%9A%94%ED%95%9C%20%EB%8D%B0%EC%9D%B4%ED%84%B0%20%EC%95%94%ED%98%B8%ED%99%94%20%EB%93%B1)

## [[MSA]]

## [[Devops]]

## 프로젝트를 [[모듈]]로 구성

## [[분산]]

- 단순한 동작을 여러겹으로 겹치면 깔끔하고 보기도 좋지 않을까?

---

## SRE

To upgrade site reliability

1. Monitoring
   - Monitoring various content
   - Make automation
2. Performance check

Quick recovery scenario

- Check error 5xx, when error occurred rollback to prev version. And reporting
  error situation. Which are link, behavior, data, code line, build package,
  (commit source)

#### 서비스 사용자 수용량 확인

서비스가 빠른지 확인 방법 Throughput, Latency

- Throughput 시간당 처리량 TPS, RPS 등
  - 병목 발생한다
- Latency 응답 지연 시간
  - 모든 서비스 지연시간이 영향을 준다

부하발생시키기

## 아키텍처 레퍼런스

#### 시퀀스

어두운 도서관 입구에서 시작해서  
가장 중심인 곳은 가장 밝은 판테온 형태의 밝은 전시관이 있다

[[2022-05-01#빨강 - 핑크 - 보라]]

#### 패턴화

가드레일을 만들되 자유도를 느낄 수 있도록

젤다의전설  
오픈형월드게임

#### 당근마켓 당근페이 인프라 구축 이야기

핀테크 기업으로서 보안 등 제약이 있는 상황에서 클라우드 서비스를 이용해야 했음

1. 로그인서비스를 어떻게 구성했는가
   - 계정 별로 환경 분리
   - 로그인 제한 -> 계정 별로 분리되어있지만 로그인은 대표계정에서 한다. cloudfnc와 동일하네
     - 로그인은 security라는 계정이고 이 계정은 로그인만을 위해서 사용하고, 이렇게 로그인하면 dev, sta, prod 계정에 접속이 가능하게 된다. 외부 접근권한이 있는 security가 탈취되어도 dev에 접근 못하게 되면 아무것도 할 수 없다는 식
   - 계정 탈취 시 여파 최소화
2. 서버 접근을 어떻게 할 것인가
   - teleport - ssh 접속 후 행동을 영상으로 녹화해서 보여준다
3. 애플리케이션 구성을 어떻게 할 것인가
   - kubernetes vs ec2
   - 쿠버네티스가 오버 엔지니어링이 아닐까 싶었지만
     같은 회사 다른 서비스에서 사용중이어서 조언을 얻을 수 있었고, 같은 팀의 팀원이 사용 경험이 있어서 충분히 도움을 받을 수 있는 환경이어서 사용하기로 했다
   - alb -> istio 변환 예정
4. 배포 파이프라인 구성을 어떻게 할 것인가
   - eks 에 맞는 도구를 찾으려고 했다
   - 툴에 대한 운영 경험이 있고 Github과 연계가 손쉽게 구성될 수 있는 기술 스택 선택
   - Github Actions, Argocd, Argocd pipeline
   - github 설치형을 n5.4xlarge 에 사용. 디스크 관리만 하면 무리없이 사용하기에 좋았음
5. 관측 시스템을 어떻게 구성할 것인가
   - 컨플라이언스 (보안) 문제로 SaaS 사용이 힘들었음 (Datadog, new relic 등)
   - ElasticStack, Prometheus, Grafana 로 직접 구축
   - FileBeat, Node Exporter 는 DaemonSet으로 올림
   - Prometheus Operator를 이용해 Prometheus를 구성함
   - AWS 리소스는 CloudWatch를 통해 모니터링
     - SNS -> AWS Chatbot을 통해 Slack 으로 발송. (이전에는 람다를 직접 구현했어야했음)
6. 성능 테스트를 어떻게 진행할 것인가
   - locust (kubernetes용인 klocust를 이용)
   - 테스트의 목적
     - 최대 성능을 측정하는 형태는 목적이 불분명
     - 10분 동안의 테스트를 통해 99퍼센타일 응답 시간이 100 ms 이내일 때의 최대 TPS를 구하려고 함 -> 99%가 진행됐을 때의 응답 시간이 100ms ?
     - 파드 하나당 400TPS 라는 수치를 얻게 됨
   - 테스트를 하면서 close_wait 소켓이 쌓이는 현상 발견. undertow를 netty로 변경

https://www.youtube.com/watch?v=8a2-b9X7Xno

## 분산

1인가구, 마이크로 서비스 아키텍처, 블록체인의 탈중앙화가 닮은 것 같다

- 탈중앙화
- 분산화
- 민주주의
- 분산 서비스
- 고가용성
- 마이크로서비스
- 조직 구조도?

확장은 필연적으로 복잡성을 만든다

[[Technology#분산 대 탈중앙화]]

#### 이동통신 시스템이 분산 처리 시스템에서 잘 돌아가고 있는 사례인 것 같다

데이터베이스의 레플리카 기능과 샤딩
일라스틱서치
하둡

#### Multi Processing

분산 시스템의 고민과 비슷한 고민이 멀티 프로세스를 사용하려는 시도에도 있겠다.

MPI라는 인터페이스가 있다.

- https://operatingsystems.tistory.com/entry/High-Performance-Computing-MPI
- http://hpcschool.kr/usc/wp-content/uploads/sites/10/2014/04/MPI.pdf

Apache의 MPM

#### 분산 개발 환경의 해결책으로 ci가 나왔다

분산 서비스간의 통합도 ci 같이 할 수 있을까

일단 데이터를 통합하는 서비스를 이용한다던가

#### 계층적인 것과 분산된 것

중첩
폴더 안에 폴더를 두는 구조는 유용하지만 복잡해져서 별로 안좋은 것 같다
그래서 프로젝트 사이즈도 폴더 중첩이 없는 정도로 나누고 싶은데
그러다보면 작은 덩어리가 많아져서 어디에 무엇이 있는지 모를 수 있겠다
그래서 정돈이 필요한데, 이 정돈을 어떻게 할 수 있을까

트리 구조의 깊이가 깊어지는 것과 넓이가 넓어지는 것은 비슷한 복잡도인가?

넓이가 넓어져서 관리가 힘들 상황을 생각해보면, 놀이터가 넓으면 선생님이 주변에
있는 아이가 아니면 어떤 일이 벌어지는지 알 수 없다

복잡성을 염두에 두고 미리 뼈대를 만들어 놓는 것보다, 작게 분리하는 것이 복잡성을
컨트롤 할 더 나은 방법 같다.
자바의 폴더구조가 처음부터 중첩된 폴더를 미리 만들어 놓는 방식인데, 이런 부분이
거슬린다. 폴더 안에 폴더가 들어가면서 깊어지면 컨트롤이 어려워질 것 같다.

- 근데 go standard layout 에서 cmd 폴더 안에 메인 함수들을 폴더로 구성하게 하는
  것을 추천해서 자바와 비슷한 구조를 베스트 프렉티스로 했다. 복잡한 서비스에서는
  중첩이 최선인가. 3단 중첩은 필요한가

[[About_Development#module]]

#### 마이크로서비스의 해법을 다른 분산 시스템에서 얻고자 한다

전체를 퉁쳐서 하나로 규정하려는게 아니라
기존의 문제점들을 확인하고 어떤 해법들이 있었는지 정보를 얻기 위해서

#### 라즈베리파이

라즈베리파이를 여러 대 두면 라즈베리파이가 하나씩 고장날 때마다 고쳐야 한다는
의미도 된다.
데스크탑 하나만 쓰면 전체가 한번에 관리된다.
물론 라즈베리파이 쪽이 싸게 처리되지만, 100대가 있을 때 매번 고치기는 힘들 것
같다.

대신 라즈베리파이 하나가 고장나도 시스템은 그대로 유지될 수 있다는 장점이 있다.

#### 아키텍처 노하우

- 변하는 것과 변하지 않을 것을 구분하기 위한 나열
- 시나리오 전개
- 완성본을 상상
- 적재적소

#### 알림 시스템 설계

가상 면접 사례로 배우는 대규모 시스템 설계 기초

- 인사이트

10장 알림 시스템 설계

kums의 설계와 매우 유사하게 구성되어있다  
신기하다

#### 정적페이지로 최대한 만들어서 cdn 이용하기

#### 모든것을 위한 클라우드는 없다

그럼 트리 구조로 선택 가능한가
회귀 가능한 요소는 어떤게 있을까
집약 세분화 집약 세분화
비용
사용자
시간
공간

#### 코드 짤때 고려할점

응집도 결합도
동시성 (병목)
멱등성
가독성
에러처리

#### 좋은 아키텍처가 성공을 보장하지는 않지만 나쁘면 망한다

나쁘지 않게 하는 것은 되야한다
완벽보다는 안정
Ddd는 쉽게 설명가능한가? 복잡한 구조라도 쉽게 설명되면 된다
쉽게설명되지 않으면 나쁘다
객체지향을 넘어 인간지향 인간중심
나쁘면 안된다는걸 생각하지만 안티패턴을 피하는 방어적 접근보다는 좋은걸 찾는 공격적 접근을 하고싶다

아키텍처가 시스템 구성을 다 정하는게 아니라
이해관계자와 먼저 요구사항을 정의하고
팀원들과 기술적 문제해결방법을 의논하고 패턴을 같이 찾고 정하게 되는 건가보다

충섭팀장님의 쿰스를 이끄는게 아키텍처의 모습을 그대로 보여준거 같다 잘 기억해야할듯

푸시 개발했던게 프로젝트 진행하면서 중간에 반발이 생긴 사례인거 같다 푸시 개발 과정을 정리하는 것도 좋을듯
Nhn에 수많은 요청을 보낸것부터 새로운 api 개방을 요청하고 사용한 것까지

> 개발자에서 아키텍트로 - 마이클 킬링
